import{createNormalizer as e}from"@zag-js/types";import{nanoid as t}from"nanoid";import{INIT_STATE as n,MachineStatus as r,createScope as i,mergeProps as a}from"@zag-js/core";import{proxy as o,subscribe as s}from"@zag-js/store";import{compact as c,identity as l,isEqual as u,isFunction as d,isString as f,runIfFn as p,toArray as m,warn as h}from"@zag-js/utils";const g={onFocus:`onFocusin`,onBlur:`onFocusout`,onChange:`onInput`,onDoubleClick:`onDblclick`,htmlFor:`for`,className:`class`,defaultValue:`value`,defaultChecked:`checked`},_=e=>{let t=``;for(let n in e){let r=e[n];if(r==null)continue;n.startsWith(`--`)||(n=n.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)),t+=`${n}:${r};`}return t},v=e(e=>Object.entries(e).reduce((e,[t,n])=>n===void 0?e:(t in g&&(t=g[t]),t===`style`&&typeof n==`object`?(e.style=_(n),e):(e[t.toLowerCase()]=n,e)),{})),y=new Map;function b(e,n,r){e.__spreadId||=`spread_${t()}`;let i=``;i=r?`${e.__spreadId}_${r}`:`${e.__spreadId}`;let a=y.get(i)||{},o=Object.keys(n),s=(t,n)=>{e.addEventListener(t.toLowerCase(),n)},c=(t,n)=>{e.removeEventListener(t.toLowerCase(),n)},l=e=>e.startsWith(`on`),u=e=>!e.startsWith(`on`),d=e=>s(e.substring(2),n[e]),f=e=>c(e.substring(2),n[e]),p=t=>{let r=n[t],i=a[t];if(r!==i){if(typeof r==`boolean`&&(t.includes(`aria-`)||(r||=void 0)),r!=null){[`value`,`checked`,`htmlFor`].includes(t)?e[t]=r:e.setAttribute(t.toLowerCase(),r);return}e.removeAttribute(t.toLowerCase())}};for(let t in a)n[t]??e.removeAttribute(t.toLowerCase());let m=Object.keys(a).filter(l);return m.forEach(e=>{c(e.substring(2),a[e])}),o.filter(l).forEach(d),o.filter(u).forEach(p),y.set(i,n),function(){o.filter(l).forEach(f)}}function x(e){let t=e().value??e().defaultValue;e().debug&&console.log(`[bindable > ${e().debug}] initial`,t);let n=e().isEqual??Object.is,r=o({value:t}),i=()=>e().value!==void 0;return{initial:t,ref:r,get(){return i()?e().value:r.value},set(t){let a=r.value,o=d(t)?t(a):t;e().debug&&console.log(`[bindable > ${e().debug}] setValue`,{next:o,prev:a}),i()||(r.value=o),n(o,a)||e().onChange?.(o,a)},invoke(t,n){e().onChange?.(t,n)},hash(t){return e().hash?.(t)??String(t)}}}x.cleanup=e=>{},x.ref=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}};function S(e){let t={current:e};return{get(e){return t.current[e]},set(e,n){t.current[e]=n}}}var C=class{scope;ctx;prop;state;refs;computed;event={type:``};previousEvent;effects=new Map;transition=null;cleanups=[];subscriptions=[];getEvent=()=>({...this.event,current:()=>this.event,previous:()=>this.previousEvent});getState=()=>({...this.state,matches:(...e)=>e.includes(this.state.get()),hasTag:e=>!!this.machine.states[this.state.get()]?.tags?.includes(e)});debug=(...e)=>{this.machine.debug&&console.log(...e)};notify=()=>{this.publish()};constructor(e,t={}){this.machine=e;let{id:r,ids:a,getRootNode:o}=p(t);this.scope=i({id:r,ids:a,getRootNode:o});let l=n=>{let r=p(t),i=e.props?.({props:c(r),scope:this.scope})??r;return i[n]};this.prop=l;let u=e.context?.({prop:l,bindable:x,scope:this.scope,flush(e){queueMicrotask(e)},getContext(){return d},getComputed(){return f},getRefs(){return m},getEvent:this.getEvent.bind(this)});u&&Object.values(u).forEach(e=>{let t=s(e.ref,()=>this.notify());this.cleanups.push(t)});let d={get(e){return u?.[e].get()},set(e,t){u?.[e].set(t)},initial(e){return u?.[e].initial},hash(e){let t=u?.[e].get();return u?.[e].hash(t)}};this.ctx=d;let f=t=>e.computed?.[t]({context:d,event:this.getEvent(),prop:l,refs:this.refs,scope:this.scope,computed:f})??{};this.computed=f;let m=S(e.refs?.({prop:l,context:d})??{});this.refs=m;let h=x(()=>({defaultValue:e.initialState({prop:l}),onChange:(t,r)=>{if(r){let e=this.effects.get(r);e?.(),this.effects.delete(r)}r&&this.action(e.states[r]?.exit),this.action(this.transition?.actions);let i=this.effect(e.states[t]?.effects);if(i&&this.effects.set(t,i),r===n){this.action(e.entry);let t=this.effect(e.effects);t&&this.effects.set(n,t)}this.action(e.states[t]?.entry)}}));this.state=h,this.cleanups.push(s(this.state.ref,()=>this.notify()))}send=e=>{this.status===r.Started&&queueMicrotask(()=>{this.previousEvent=this.event,this.event=e,this.debug(`send`,e);let t=this.state.get(),n=this.machine.states[t].on?.[e.type]??this.machine.on?.[e.type],r=this.choose(n);if(!r)return;this.transition=r;let i=r.target??t;this.debug(`transition`,r);let a=i!==t;a?this.state.set(i):this.action(r.actions)})};action=e=>{let t=d(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.actions?.[e];return t||h(`[zag-js] No implementation found for action "${JSON.stringify(e)}"`),t});for(let e of n)e?.(this.getParams())};guard=e=>d(e)?e(this.getParams()):this.machine.implementations?.guards?.[e](this.getParams());effect=e=>{let t=d(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.effects?.[e];return t||h(`[zag-js] No implementation found for effect "${JSON.stringify(e)}"`),t}),r=[];for(let e of n){let t=e?.(this.getParams());t&&r.push(t)}return()=>r.forEach(e=>e?.())};choose=e=>m(e).find(e=>{let t=!e.guard;return f(e.guard)?t=!!this.guard(e.guard):d(e.guard)&&(t=e.guard(this.getParams())),t});start(){this.status=r.Started,this.debug(`initializing...`),this.state.invoke(this.state.initial,n),this.setupTrackers()}stop(){this.effects.forEach(e=>e?.()),this.effects.clear(),this.transition=null,this.action(this.machine.exit),this.cleanups.forEach(e=>e()),this.cleanups=[],this.status=r.Stopped,this.debug(`unmounting...`)}subscribe=e=>{this.subscriptions.push(e)};status=r.NotStarted;get service(){return{state:this.getState(),send:this.send,context:this.ctx,prop:this.prop,scope:this.scope,refs:this.refs,computed:this.computed,event:this.getEvent(),getStatus:()=>this.status}}publish=()=>{this.callTrackers(),this.subscriptions.forEach(e=>e(this.service))};trackers=[];setupTrackers=()=>{this.machine.watch?.(this.getParams())};callTrackers=()=>{this.trackers.forEach(({deps:e,fn:t})=>{let n=e.map(e=>e());u(t.prev,n)||(t(),t.prev=n)})};getParams=()=>({state:this.getState(),context:this.ctx,event:this.getEvent(),prop:this.prop,send:this.send,action:this.action,guard:this.guard,track:(e,t)=>{t.prev=e.map(e=>e()),this.trackers.push({deps:e,fn:t})},refs:this.refs,computed:this.computed,flush:l,scope:this.scope,choose:this.choose})},w=class{document;machine;api;hydrator=null;userProps;get doc(){return this.document}constructor(e,t=document){this.document=t,this.userProps=e,this.machine=this.initMachine(e),this.api=this.initApi()}init(){this.hydrator=new D(this.name,this.machine.scope.id,this.machine.scope.ids,this.doc),this.render(),this.machine.subscribe(()=>{this.api=this.initApi(),this.render()}),this.machine.start()}updateProps(e){this.machine.stop(),this.machine=this.initMachine({...this.userProps,...e}),this.api=this.initApi(),this.init()}destroy=()=>{this.machine.stop(),this.hydrator?.destroy()};spreadProps(e,t){b(e,t,this.machine.scope.id)}getElement(e){return this.hydrator?.getElement(e)||null}getElements(e){return this.hydrator?.getElements(e)||[]}portalElement(e,t=this.doc.body){e&&e.parentNode!==t&&(t.appendChild(e),e.setAttribute(`data-portalled`,`true`))}};function T(e,t){let n=window.FluidUI.hydrationData;return!n||typeof n!=`object`?null:e?n[e]?t?n[e][t]||null:n[e]:null:n}function E(e,t){let n=T(e);n&&Object.keys(n).forEach(r=>{if(n[r].controlled)return;let i=t(n[r]);window.FluidUI.uncontrolledInstances[e]||(window.FluidUI.uncontrolledInstances[e]={}),window.FluidUI.uncontrolledInstances[e][r]=i})}var D=class{componentName;doc;rootId;ids;elementRefs=new Map;constructor(e,t,n={},r=document){if(this.componentName=e,this.doc=r,!t)throw Error(`Root ID is required for component hydration: ${e}`);this.rootId=t,this.ids=n}getElement(e){if(this.elementRefs.has(e))return this.elementRefs.get(e)||null;let t=null;return t=this.ids[e]?this.doc.getElementById(this.ids[e]):this.doc.querySelector(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`),t&&(this.elementRefs.set(e,t),t.removeAttribute(`data-hydrate-${this.componentName}`),t.__rootId=this.rootId),t}getElements(e){if(this.elementRefs.has(e))return this.elementRefs.get(e);let t=[];return t=this.ids[e]?Array.from(this.doc.querySelectorAll(`#${this.ids[e]}`)):Array.from(this.doc.querySelectorAll(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`)),this.elementRefs.set(e,t),t.forEach(e=>e.removeAttribute(`data-hydrate-${this.componentName}`)),t}generateRefAttributesString(e){let t=this.ids[e]||`${this.rootId}-${e}`;return`data-scope="${this.componentName}" data-part="${e}" data-hydrate-${this.componentName}="${t}"`}setRefAttributes(e,t){let n=this.generateRefAttributesString(t),r=n.split(` `).map(e=>e.trim());r.forEach(t=>{let[n,r]=t.split(`=`);e.setAttribute(n,r.replace(/"/g,``))})}destroy(){this.elementRefs.clear()}};export{w as Component,D as ComponentHydrator,C as Machine,T as getHydrationData,E as initAllComponentInstances,a as mergeProps,v as normalizeProps,b as spreadProps};