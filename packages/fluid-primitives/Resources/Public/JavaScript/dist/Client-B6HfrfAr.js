import{INIT_STATE as e,MachineStatus as t,createScope as n,mergeProps as r}from"@zag-js/core";import{proxy as i,subscribe as a}from"@zag-js/store";import{compact as o,identity as s,isEqual as c,isFunction as l,isString as u,runIfFn as d,toArray as f,warn as p}from"@zag-js/utils";import{createNormalizer as m}from"@zag-js/types";import{nanoid as h}from"nanoid";var g=class{document;machine;api;hydrator=null;userProps;get doc(){return this.document}constructor(e,t=document){this.document=t,this.userProps=e,this.machine=this.initMachine(e),this.api=this.initApi()}init(){this.hydrator=new y(this.name,this.machine.scope.id,this.machine.scope.ids,this.doc),this.render(),this.machine.subscribe(()=>{this.api=this.initApi(),this.render()}),this.machine.start()}updateProps(e){this.machine.stop(),this.machine=this.initMachine({...this.userProps,...e}),this.api=this.initApi(),this.init()}destroy=()=>{this.machine.stop(),this.hydrator?.destroy()};spreadProps(e,t){D(e,t,this.machine.scope.id)}getElement(e){return this.hydrator?.getElement(e)||null}getElements(e){return this.hydrator?.getElements(e)||[]}portalElement(e,t=this.doc.body){e&&e.parentNode!==t&&(t.appendChild(e),e.setAttribute(`data-portalled`,`true`))}};function _(e,t){let n=window.FluidPrimitives.hydrationData;return!n||typeof n!=`object`?null:e?n[e]?t?n[e][t]||null:n[e]:null:n}function v(e,t){let n=_(e);n&&Object.keys(n).forEach(r=>{if(n[r].controlled)return;let i=t(n[r]);window.FluidPrimitives.uncontrolledInstances[e]||(window.FluidPrimitives.uncontrolledInstances[e]={}),window.FluidPrimitives.uncontrolledInstances[e][r]=i})}var y=class{componentName;doc;rootId;ids;elementRefs=new Map;constructor(e,t,n={},r=document){if(this.componentName=e,this.doc=r,!t)throw Error(`Root ID is required for component hydration: ${e}`);this.rootId=t,this.ids=n}getElement(e){if(this.elementRefs.has(e))return this.elementRefs.get(e)||null;let t=null;return t=this.ids[e]?this.doc.getElementById(this.ids[e]):this.doc.querySelector(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`),t&&(this.elementRefs.set(e,t),t.removeAttribute(`data-hydrate-${this.componentName}`),t.__rootId=this.rootId),t}getElements(e){if(this.elementRefs.has(e))return this.elementRefs.get(e);let t=[];return t=this.ids[e]?Array.from(this.doc.querySelectorAll(`#${this.ids[e]}`)):Array.from(this.doc.querySelectorAll(`[data-hydrate-${this.componentName}="${this.rootId}"][data-part="${e}"][data-scope="${this.componentName}"]`)),this.elementRefs.set(e,t),t.forEach(e=>e.removeAttribute(`data-hydrate-${this.componentName}`)),t}generateRefAttributesString(e){let t=this.ids[e]||`${this.rootId}-${e}`;return`data-scope="${this.componentName}" data-part="${e}" data-hydrate-${this.componentName}="${t}"`}setRefAttributes(e,t){let n=this.generateRefAttributesString(t),r=n.split(` `).map(e=>e.trim());r.forEach(t=>{let[n,r]=t.split(`=`);e.setAttribute(n,r.replace(/"/g,``))})}destroy(){this.elementRefs.clear()}};function b(e){let t=e().value??e().defaultValue;e().debug&&console.log(`[bindable > ${e().debug}] initial`,t);let n=e().isEqual??Object.is,r=i({value:t}),a=()=>e().value!==void 0;return{initial:t,ref:r,get(){return a()?e().value:r.value},set(t){let i=r.value,o=l(t)?t(i):t;e().debug&&console.log(`[bindable > ${e().debug}] setValue`,{next:o,prev:i}),a()||(r.value=o),n(o,i)||e().onChange?.(o,i)},invoke(t,n){e().onChange?.(t,n)},hash(t){return e().hash?.(t)??String(t)}}}b.cleanup=e=>{},b.ref=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}};function x(e){let t={current:e};return{get(e){return t.current[e]},set(e,n){t.current[e]=n}}}var S=class{scope;ctx;prop;state;refs;computed;event={type:``};previousEvent;effects=new Map;transition=null;cleanups=[];subscriptions=[];getEvent=()=>({...this.event,current:()=>this.event,previous:()=>this.previousEvent});getState=()=>({...this.state,matches:(...e)=>e.includes(this.state.get()),hasTag:e=>!!this.machine.states[this.state.get()]?.tags?.includes(e)});debug=(...e)=>{this.machine.debug&&console.log(...e)};notify=()=>{this.publish()};constructor(t,r={}){this.machine=t;let{id:i,ids:s,getRootNode:c}=d(r);this.scope=n({id:i,ids:s,getRootNode:c});let l=e=>{let n=d(r),i=t.props?.({props:o(n),scope:this.scope})??n;return i[e]};this.prop=l;let u=t.context?.({prop:l,bindable:b,scope:this.scope,flush(e){queueMicrotask(e)},getContext(){return f},getComputed(){return p},getRefs(){return m},getEvent:this.getEvent.bind(this)});u&&Object.values(u).forEach(e=>{let t=a(e.ref,()=>this.notify());this.cleanups.push(t)});let f={get(e){return u?.[e].get()},set(e,t){u?.[e].set(t)},initial(e){return u?.[e].initial},hash(e){let t=u?.[e].get();return u?.[e].hash(t)}};this.ctx=f;let p=e=>t.computed?.[e]({context:f,event:this.getEvent(),prop:l,refs:this.refs,scope:this.scope,computed:p})??{};this.computed=p;let m=x(t.refs?.({prop:l,context:f})??{});this.refs=m;let h=b(()=>({defaultValue:t.initialState({prop:l}),onChange:(n,r)=>{if(r){let e=this.effects.get(r);e?.(),this.effects.delete(r)}r&&this.action(t.states[r]?.exit),this.action(this.transition?.actions);let i=this.effect(t.states[n]?.effects);if(i&&this.effects.set(n,i),r===e){this.action(t.entry);let n=this.effect(t.effects);n&&this.effects.set(e,n)}this.action(t.states[n]?.entry)}}));this.state=h,this.cleanups.push(a(this.state.ref,()=>this.notify()))}send=e=>{this.status===t.Started&&queueMicrotask(()=>{this.previousEvent=this.event,this.event=e,this.debug(`send`,e);let t=this.state.get(),n=this.machine.states[t].on?.[e.type]??this.machine.on?.[e.type],r=this.choose(n);if(!r)return;this.transition=r;let i=r.target??t;this.debug(`transition`,r);let a=i!==t;a?this.state.set(i):this.action(r.actions)})};action=e=>{let t=l(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.actions?.[e];return t||p(`[zag-js] No implementation found for action "${JSON.stringify(e)}"`),t});for(let e of n)e?.(this.getParams())};guard=e=>l(e)?e(this.getParams()):this.machine.implementations?.guards?.[e](this.getParams());effect=e=>{let t=l(e)?e(this.getParams()):e;if(!t)return;let n=t.map(e=>{let t=this.machine.implementations?.effects?.[e];return t||p(`[zag-js] No implementation found for effect "${JSON.stringify(e)}"`),t}),r=[];for(let e of n){let t=e?.(this.getParams());t&&r.push(t)}return()=>r.forEach(e=>e?.())};choose=e=>f(e).find(e=>{let t=!e.guard;return u(e.guard)?t=!!this.guard(e.guard):l(e.guard)&&(t=e.guard(this.getParams())),t});start(){this.status=t.Started,this.debug(`initializing...`),this.state.invoke(this.state.initial,e),this.setupTrackers()}stop(){this.effects.forEach(e=>e?.()),this.effects.clear(),this.transition=null,this.action(this.machine.exit),this.cleanups.forEach(e=>e()),this.cleanups=[],this.status=t.Stopped,this.debug(`unmounting...`)}subscribe=e=>{this.subscriptions.push(e)};status=t.NotStarted;get service(){return{state:this.getState(),send:this.send,context:this.ctx,prop:this.prop,scope:this.scope,refs:this.refs,computed:this.computed,event:this.getEvent(),getStatus:()=>this.status}}publish=()=>{this.callTrackers(),this.subscriptions.forEach(e=>e(this.service))};trackers=[];setupTrackers=()=>{this.machine.watch?.(this.getParams())};callTrackers=()=>{this.trackers.forEach(({deps:e,fn:t})=>{let n=e.map(e=>e());c(t.prev,n)||(t(),t.prev=n)})};getParams=()=>({state:this.getState(),context:this.ctx,event:this.getEvent(),prop:this.prop,send:this.send,action:this.action,guard:this.guard,track:(e,t)=>{t.prev=e.map(e=>e()),this.trackers.push({deps:e,fn:t})},refs:this.refs,computed:this.computed,flush:s,scope:this.scope,choose:this.choose})};const C={onFocus:`onFocusin`,onBlur:`onFocusout`,onChange:`onInput`,onDoubleClick:`onDblclick`,htmlFor:`for`,className:`class`,defaultValue:`value`,defaultChecked:`checked`},w=e=>{let t=``;for(let n in e){let r=e[n];if(r==null)continue;n.startsWith(`--`)||(n=n.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)),t+=`${n}:${r};`}return t},T=m(e=>Object.entries(e).reduce((e,[t,n])=>n===void 0?e:(t in C&&(t=C[t]),t===`style`&&typeof n==`object`?(e.style=w(n),e):(e[t.toLowerCase()]=n,e)),{})),E=new Map;function D(e,t,n){e.__spreadId||=`spread_${h()}`;let r=``;r=n?`${e.__spreadId}_${n}`:`${e.__spreadId}`;let i=E.get(r)||{},a=Object.keys(t),o=(t,n)=>{e.addEventListener(t.toLowerCase(),n)},s=(t,n)=>{e.removeEventListener(t.toLowerCase(),n)},c=e=>e.startsWith(`on`),l=e=>!e.startsWith(`on`),u=e=>o(e.substring(2),t[e]),d=e=>s(e.substring(2),t[e]),f=n=>{let r=t[n],a=i[n];if(r!==a){if(typeof r==`boolean`&&(n.includes(`aria-`)||(r||=void 0)),r!=null){[`value`,`checked`,`htmlFor`].includes(n)?e[n]=r:e.setAttribute(n.toLowerCase(),r);return}e.removeAttribute(n.toLowerCase())}};for(let n in i)t[n]??e.removeAttribute(n.toLowerCase());let p=Object.keys(i).filter(c);return p.forEach(e=>{s(e.substring(2),i[e])}),a.filter(c).forEach(u),a.filter(l).forEach(f),E.set(r,t),function(){a.filter(c).forEach(d)}}export{g as Component,y as ComponentHydrator,S as Machine,_ as getHydrationData,v as initAllComponentInstances,r as mergeProps,T as normalizeProps,D as spreadProps};